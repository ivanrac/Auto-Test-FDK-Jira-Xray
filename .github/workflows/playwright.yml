name: FDK Playwright Testy & Xray Report

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # UMO≈Ω≈áUJE MANU√ÅLNE SPUSTENIE
  workflow_dispatch:

  # ----------------------------------------------------
  # Nastavenie denn√©ho spustenia
  # Spusti≈• ka≈æd√Ω de≈à o 05:00 UTC
  # ----------------------------------------------------
  schedule:
    - cron: '0 5 * * *'
    
jobs:
  test_and_report:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
      
    # ----------------------------------------------------
    # Krok 1: Spustenie testov a generovanie JUnit XML
    # ----------------------------------------------------
    - name: Run Playwright tests
      run: npx playwright test
      
    # ====================================================
    # NOV√ù KROK: Poslanie e-mailu pri ZLYHAN√ç testov
    # ====================================================
    - name: Send Failure Notification Email
      if: failure() # Spust√≠ sa LEN ak predch√°dzaj√∫ci krok zlyhal
      uses: dawidd6/action-send-mail@v3
      with:
        # SMTP KONFIGUR√ÅCIA (Pou≈æijeme Gmail s Portom 465)
        server_address: ${{ secrets.MAIL_SERVER }} 
        server_port: ${{ secrets.MAIL_PORT }}     # Je nastaven√© na 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}    
        
        # NASTAVEN√â PRE PORT 465 (SSL/TLS)
        from: ${{ secrets.MAIL_USERNAME }}
        secure: true # Spr√°vne nastavenie pre Gmail SMTP
        
        # Nastavenie pr√≠jemcov - V√°≈° mail je odosielateƒæ, tieto adresy s√∫ pr√≠jemcovia
        to: |
          martin.kucera@ekultura.eu
          tester033@seznam.cz  

        # Obsah spr√°vy
        subject: 'üö® CRON JOB ZLYHAL: Playwright Login Test (FDK Repo)'
        body: |
          Ahoj,
          Automatizovan√Ω rann√Ω Playwright test prihl√°senia (spusten√Ω cez Cron) ZLYHAL.
          
          Pros√≠m, skontrolujte logy akcie pre viac detailov:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          GitHub Action: FDK Playwright Testy & Xray Report
        
    # ----------------------------------------------------
    # Krok 2: Nahr√°vanie v√Ωsledkov do Xray POMOCOU cURL SKRIPTU
    # ----------------------------------------------------
    - name: Upload results to Xray via cURL
      if: always() # Spust√≠ sa v≈ædy, aby sa nahrali aj zlyhan√© testy
      env:
        XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}  
        XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
      run: |
        # 1. Z√≠skanie Xray Tokenu
        XRAY_AUTH_URL="https://xray.cloud.getxray.app/api/v2/authenticate"
        XRAY_IMPORT_URL="https://xray.cloud.getxray.app/api/v2/import/execution/junit"
        REPORT_FILE="./playwright-results/results.xml"
        
        echo "1/2: Z√≠skavam Xray autentifikaƒçn√Ω token..."
        XRAY_TOKEN=$(curl -s -X POST $XRAY_AUTH_URL \
             -H "Content-Type: application/json" \
             -d "{\"client_id\": \"$XRAY_CLIENT_ID\", \"client_secret\": \"$XRAY_CLIENT_SECRET\"}" | tr -d '"')

        if [ -z "$XRAY_TOKEN" ]; then
            echo "CHYBA: Nepodarilo sa z√≠ska≈• Xray Token. Nahr√°vanie preru≈°en√©."
            exit 0
        fi
        
        echo "Token √∫spe≈°ne z√≠skan√Ω. Nahr√°vam v√Ωsledky..."
        
        # 2. Nahr√°vanie JUnit XML do Xray a priradenie k testu FDK-29
        curl -X POST "${XRAY_IMPORT_URL}?projectKey=FDK&testIssueKey=FDK-29&summary=Automatizovan√Ω%20Playwright%20Run%20-%20Valid%20Login%20(CI)" \
             -H "Content-Type: text/xml" \
             -H "Authorization: Bearer $XRAY_TOKEN" \
             --data-binary "@$REPORT_FILE"

        echo ""
        echo "Nahr√°vanie dokonƒçen√©. V√Ωsledok n√°jdete v JIRA."
