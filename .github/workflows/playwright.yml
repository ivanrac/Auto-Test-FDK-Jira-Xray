name: FDK Playwright Testy & Xray Report

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # UMOŽŇUJE MANUÁLNE SPUSTENIE
  workflow_dispatch:

  # ----------------------------------------------------
  # NOVÉ: Nastavenie denného spustenia
  # Spustiť každý deň o 05:00 UTC
  # ----------------------------------------------------
  schedule:
    - cron: '0 5 * * *' 

jobs:
  test_and_report:
    # Ak celý job spadne (pretože testy zlyhajú), pošle notifikáciu.
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
      
    # ----------------------------------------------------
    # Krok 1: Spustenie testov a generovanie JUnit XML
    # ----------------------------------------------------
    - name: Run Playwright tests
      run: npx playwright test --UNKNOWN_FAIL_COMMAND
      
    # ----------------------------------------------------
    # Krok 2: Nahrávanie výsledkov do Xray POMOCOU cURL SKRIPTU
    # Xray sa spustí VŽDY, aby sa nahral status FAIL/PASS
    # ----------------------------------------------------
    - name: Upload results to Xray via cURL
      if: always() 
      env:
        XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }} 
        XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
      run: |
        # 1. Získanie Xray Tokenu
        XRAY_AUTH_URL="https://xray.cloud.getxray.app/api/v2/authenticate"
        XRAY_IMPORT_URL="https://xray.cloud.getxray.app/api/v2/import/execution/junit"
        REPORT_FILE="./playwright-results/results.xml"
        
        echo "1/2: Získavam Xray autentifikačný token..."
        XRAY_TOKEN=$(curl -s -X POST $XRAY_AUTH_URL \
             -H "Content-Type: application/json" \
             -d "{\"client_id\": \"$XRAY_CLIENT_ID\", \"client_secret\": \"$XRAY_CLIENT_SECRET\"}" | tr -d '"')

        if [ -z "$XRAY_TOKEN" ]; then
            echo "CHYBA: Nepodarilo sa získať Xray Token. Nahrávanie prerušené."
            exit 0
        fi
        
        echo "Token úspešne získaný. Nahrávam výsledky..."
        
        # 2. Nahrávanie JUnit XML do Xray a priradenie k testu FDK-29
        # Používame endpoint s parametrami ProjectKey a TestIssueKey
        curl -X POST "${XRAY_IMPORT_URL}?projectKey=FDK&testIssueKey=FDK-29&summary=Automatizovaný%20Playwright%20Run%20-%20Valid%20Login%20(CI)" \
              -H "Content-Type: text/xml" \
              -H "Authorization: Bearer $XRAY_TOKEN" \
              --data-binary "@$REPORT_FILE"

        echo ""
        echo "Nahrávanie dokončené. Výsledok nájdete v JIRA."
